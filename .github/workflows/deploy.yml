name: deploy

# êµ¬ë…í•  ì´ë²¤íŠ¸
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# jobs ë‹¨ìœ„ë¡œ ê°œë³„ ì„œë²„(ì •í™•íˆëŠ” Docker ì»¨í…Œì´ë„ˆ ë‹¨ìœ„ë¼ê³  í•œë‹¤.)ì—ì„œ ì‘ì—…ì´ ìˆ˜í–‰ëœë‹¤.
jobs:
  build-and-deploy:
    # Ubuntu, Windows, MacOSë¥¼ ì§€ì›í•œë‹¤.
    runs-on: ubuntu-22.04

    strategy:
      matrix:
        node-version: [18.12.0]

    # uses ê°œë…ì€ ë‹¤ë¥¸ ì‚¬ëŒì´ ì‘ì„±í•œ ë‚´ìš©ì„ ì‹¤í–‰í•˜ëŠ” ê°œë…ì´ë‹¤.
    # run ê°œë…ì€ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•œë‹¤. ì…¸ ìŠ¤í¬ë¦½íŠ¸ì™€ ë™ì¼í•˜ë‹¤.
    steps:
      - name: âœ… ì†ŒìŠ¤ì½”ë“œ Checkout.
        uses: actions/checkout@v3
        # actions/checkout: GitHubì˜ ë§ˆì§€ë§‰ ì»¤ë°‹ìœ¼ë¡œ Checkout í•œë‹¤.

      - name: âš™ï¸ ${{ matrix.node-version }} ë²„ì „ì˜ ë…¸ë“œë¡œ ì„¸íŒ…
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
        # actions/setup-node: Node.jsë¥¼ ì„¤ì¹˜í•œë‹¤.

      - name: âš™ï¸ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ì„¤ì •
        working-directory: ./
        run: |
          pwd
          touch .env
          echo PORT=${{ secrets.PORT }} >> .env
          cat .env
        # ê¹ƒí—™ì˜ ë ˆí¬ > Settings > Security > Secrets > Actionsì— í™˜ê²½ ë³€ìˆ˜ë¥¼ ë¯¸ë¦¬ ë“±ë¡í•˜ì.

      - name: âœ¨ íŒ¨í‚¤ì§€ ì„¤ì¹˜
        working-directory: ./
        run: npm install
        
      - name: âœ¨ Test ì§„í–‰
        run: npm test
        # package.jsonì— ì •ì˜ëœ scriptì¤‘ testë¥¼ ì´ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‹¤í–‰
        
      - name: âœ¨ ë¹Œë“œ ê³¼ì • ì‹œì‘
        working-directory: ./
        run: npm run build --if-present
        # --if-present ì˜µì…˜ì€ npm ìŠ¤í¬ë¦½íŠ¸ê°€ ì¡´ì¬í•  ë•Œë§Œ ì‹¤í–‰ì‹œí‚¤ë¼ëŠ” ì˜ë¯¸ì´ë‹¤.
        # ë§Œì•½ build ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ëŠ” ê²½ìš°, ì˜¤ë¥˜ ì—†ì´ ì§€ë‚˜ê°„ë‹¤.
      
      - name: ğŸ“¦ ë¹Œë“œí•œ ì½”ë“œë¥¼ ì••ì¶•
        run: zip -r project.zip ./src ./scripts ./appspec.yml ./.env ./package.json
        
      - name: ğŸŒ AWSì— ì ‘ì†
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2
      
      - name: ğŸ¦– S3ì— ì••ì¶•ëœ ì„œë²„ ì½”ë“œë¥¼ ì—…ë¡œë“œ
        run: aws s3 cp --region ap-northeast-2 ./project.zip s3://nodejs-cicd-deploy-bucket/deploy/
  
      - name: ğŸš€ AWS codeDeployë¡œ ë°°í¬ë¥¼ ì‹œì‘
        run: aws deploy create-deployment
          --application-name nodejs-codedeploy
          --deployment-config-name CodeDeployDefault.OneAtATime
          --deployment-group-name dev
          --s3-location bucket=nodejs-cicd-deploy-bucket,bundleType=zip,key=deploy/project.zip
  